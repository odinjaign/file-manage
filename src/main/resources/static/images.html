<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="layui/css/layui.css" />
	</head>
	<body>
		<ul class="layui-nav layui-bg-blue">
			<li class="layui-nav-item">
				<a href="index.html"><i class="layui-icon layui-icon-home"></i></a>
			</li>
			<li class="layui-nav-item">
				<a href="musics.html">音乐</a>
			</li>
			<li class="layui-nav-item">
				<a href="movies.html">视频</a>
			</li>
			<li class="layui-nav-item">
				<a href="documents.html">文档</a>
			</li>
			<li class="layui-nav-item  layui-this">
				<a id="update-cache">图片<span id="image-count" class="layui-badge">0</span></a>
			</li>
		</ul>
<!--		<div class="layui-container" style="padding: 20px;">-->
<!--			<div id="image-list-box" class="layui-row layui-col-space15">-->

<!--			</div>-->
<!--		</div>-->

		<div id="image-list-box" class="layui-container" style="margin-top: 20px">
			<blockquote class="layui-elem-quote">
				<div class="layui-row layui-col-space5" style="text-align: center;color: #009688;">
					<div class="layui-col-md5">
						名称
<!--						<span id="update-cache" class="layui-badge layui-bg-green"><i class="layui-icon">&#xe669;</i></span>-->
					</div>
					<div class="layui-col-md2">
						类型
					</div>
					<div class="layui-col-md2">
						宽高
					</div>
					<div class="layui-col-md1">
						大小
					</div>
					<div class="layui-col-md2">
						操作
					</div>
				</div>
			</blockquote>

		</div>

		<script src="layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			layui.use(['element', 'layer'], function() {
				var element = layui.element;
				var $ = layui.$;

				//用户未登录的跳转
				$.post("/user/config/islogin", function(rel) {
					if (rel.code === -1) {
						layer.msg(rel.msg, function() {
							window.location = "login.html";
						})
					} else if (rel.code === 1) {
						layer.msg(rel.msg, function() {
							window.location = "sysconfig.html";
						})
					}
				})
				$.post("/sys/config/get", {
					key: "typeview"
				}, function(status) {
					if (!status) {
						layer.msg("分类浏览未启用", function() {
							window.location = "index.html";
						})
					}
				})


				function imageNodeHtml(node) {
					var encodePath = encodeURIComponent(node.path);

					return '\
					<blockquote class="layui-elem-quote layui-quote-nm">\
						<div class="layui-row layui-col-space5" style="text-align: center;">\
							<div class="layui-col-md5" style="text-align: left;">\
								'+node.name+'\
							</div>\
							<div class="layui-col-md2">\
								<span class="layui-badge layui-bg-blue">' +
							node.ext.toUpperCase() + '</span>\
							</div>\
							<div class="layui-col-md2">\
								<span class="layui-badge layui-bg-orange">' + node.w + 'x' + node.h +
							'</span>\
                                </div>\
                                <div class="layui-col-md1">\
                                    <span class="layui-badge layui-bg-blue">' +
								parseFloat(node.size).toLocaleString() +
								'KB</span>\
							</div>\
							<div class="layui-col-md2" data-path="' + node.path +'" data-w="' + node.w +'" data-h="' + node.h +'">\
								<button type="button" class="view-btn layui-btn layui-btn-primary layui-btn-xs">预览</button>\
								<button type="button" class="delete-btn layui-btn layui-btn-danger layui-btn-xs">删除</button>\
							</div>\
						</div>\
					</blockquote>\
					';
				};

				$.ajax({
					url: '/image/list',
					type: 'POST',
					success: function(rel) {
						console.log(rel.msg);
						if (rel.code === 0) {
							rel.data.forEach(function(val, inx) {
								$("#image-list-box").append(imageNodeHtml(val))
							});
							//渲染预览
							$("#image-count").html(rel.count);
							$(".view-btn").click(function() {

								var path = $(this).parent().attr("data-path");
								var w = $(this).parent().attr("data-w");
								var h = $(this).parent().attr("data-h");
								var _url = '/image/img?path=' + encodeURIComponent(path);
								w = h > 600 ? w / h * 600 : w
								h = h > 600 ? 600 : h
								layer.open({
									type: 1,
									title: false,
									offset: 'auto',
									area: [w + 'px', h + 'px'],
									shadeClose: true,
									content: '<div><img alt="'+path+'" style="max-width: 100%;max-height: 100%" src="' + _url + '"></div>'
								});

							});
							//删除文件
							$(".delete-btn").click(function() {

								var path = $(this).parent().attr("data-path");
								$.ajax({
									url: '/opt/delete',
									method: 'POST',
									data: {
										filepath: path
									},
									success: function(rel) {
										layer.msg(rel.msg);
										if (rel.code === 0) {
											location.reload();
										}
									}
								})
							})
						}
					}
				});

				//刷新缓存
				$('#update-cache').click(function () {
					$.post('/class/manage/del/cache',function (rel) {
						if (rel.code === 0) {
							location.reload()
						}else {
							layer.apply(rel.msg)
						}
					})
				})

			});
		</script>
	</body>
</html>
