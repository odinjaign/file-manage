<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>主页</title>
		<link rel="stylesheet" type="text/css" href="layui/css/layui.css" />
	</head>
	<body>
		<div class="layui-container" style="margin-top: 20px;">
			<fieldset class="layui-elem-field layui-field-title">
				<legend>
					主页
					<span id="now-path-span" class="layui-badge layui-bg-gray">C:</span>
				</legend>
				<div class="layui-field-box">
					<div style="margin-top: 20px">
						<div class="layui-btn-group">
							<button id="return-last-btn" type="button" class="layui-btn layui-bg-orange layui-btn-sm">
								<i class="layui-icon">&#xe65c;</i>
							</button>
							<button id="add-file-btn" type="button" class="layui-btn layui-btn-sm">
								<i class="layui-icon">&#xe624;</i>
							</button>
							<button id="upload-btn" type="button" class="layui-btn layui-btn-sm">
								<i class="layui-icon">&#xe62f;</i>
							</button>
							<button id="refresh-cache-btn" type="button" class="layui-btn layui-btn-sm">
								<i class="layui-icon">&#xe669;</i>
							</button>
						</div>

						<div class="layui-btn-group">
							<a id="typeview-btn" type="button" href="musics.html" class="layui-btn layui-bg-blue layui-btn-sm">
								<i class="layui-icon">&#xe610;</i>
							</a>
							<a id="userconfig-btn" href="userconfig.html" type="button" class="layui-btn layui-bg-gray layui-btn-sm">
								<i class="layui-icon">&#xe716;</i>
							</a>
						</div>
						
						<div class="layui-btn-group">
							<button id="change-btn-group" type="button" data-group-idx="2" class="layui-btn layui-bg-blue layui-btn-sm">
								<i class="layui-icon">&#xe62c;</i>
							</button>
						</div>
					</div>


					<div class="layui-field-box">
						<div id="file-list-box" class="layui-container">
							<blockquote class="layui-elem-quote">
								<div class="layui-row layui-col-space5" style="text-align: center;color: #009688;">
									<div class="layui-col-md4">
										名称
									</div>
									<div class="layui-col-md2">
										修改日期
									</div>
									<div class="layui-col-md1">
										类型
									</div>
									<div class="layui-col-md2">
										大小
									</div>
									<div class="layui-col-md3">
										操作
									</div>
								</div>
							</blockquote>
							<!-- <blockquote class="layui-elem-quote  layui-quote-nm">
								<div class="layui-row layui-col-space5" style="text-align: center;">
									<div class="layui-col-md5" style="text-align: left;">
										<span class="file-name-span">壁纸</span>
									</div>
									<div class="layui-col-md2">
										2020-04-22 08:19:24
									</div>
									<div class="layui-col-md1">
										<span class="layui-badge layui-bg-orange">GIF</span>
										<span class="layui-badge layui-bg-gray">文件夹</span>
									</div>
									<div class="layui-col-md2">

									</div>
									<div class="layui-col-md2">
										<div class="layui-btn-group" data-path="">
											<button type="button" class="play-btn layui-btn  layui-btn-xs">播放</button>
											<button type="button" class="delete-btn layui-btn layui-btn-xs">删除</button>
											<button type="button" class="more-btn layui-btn layui-btn-xs">删除</button>
											
										</div>
									</div>
								</div>
							</blockquote> -->

						</div>
					</div>
				</div>
			</fieldset>
		</div>
		<script src="layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			layui.use(['layer','code'], function() {
				var layer = layui.layer;
				var $ = layui.$;

				$.post('http://localhost:8080/main/pwd', function(rel) {
					console.log(rel);
					$('#now-path-span').text(rel);
				});
				
				//用户未登录的跳转
				$.post("http://localhost:8080/user/config/islogin", function(rel) {
					if (rel.code === -1) {
						layer.msg(rel.msg, function() {
							window.location = "login.html";
						})
					} else if(rel.code === 1){
						layer.msg(rel.msg, function() {
							window.location = "sysconfig.html";
						})
					}
				})
				$.post("http://127.0.0.1:8080/sys/config/get",{key:"typeview"},function(status){
					if(!status){
						$("#typeview-btn").remove();
					}
				})
				$.post("http://127.0.0.1:8080/sys/config/get",{key:"upload"},function(status){
					if(!status){
						$("#upload-btn").remove();
					}
				})
				
				
				$('#return-last-btn').click(function() {
					$.ajax({
						url: 'http://localhost:8080/main/returnlast',
						method: 'POST',
						success: function(suc) {
							//刷新页面
							if (suc) {
								// layer.msg('返回上一级成功', function () {
								location.reload();
								// })
							} else {
								layer.msg('返回上一级失败');
							}
						}
					});
				})
				$('#add-file-btn').click(function() {
					layer.open({
						title: '创建文件',
						content: '<input id="filename" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="文件名" class="layui-input"><br/><input id="foldername" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="文件夹名" class="layui-input">',
						yes: function(index, layero) {
							//do something
							var filename = $(layero.find('#filename')).val();
							var foldername = $(layero.find('#foldername')).val();
							var isfolder = false;
							var name = filename;
							if (filename !== '' && foldername === '') {
								console.log("创建文件");
								name = filename;
								isfolder = false;
							} else if (filename === '' && foldername !== '') {
								console.log("创建文件夹");
								name = foldername;
								isfolder = true;
							} else if (filename === '' && foldername === '') {
								layer.msg("请输入文件夹或者文件夹名")
								return;
							} else if (filename !== '' && foldername !== '') {
								layer.msg("只能输入一个类型");
								return;
							}
							var reqdata = {
								filename: name,
								isfolder: isfolder
							};
							//创建文件（夹）
							$.ajax({
								url: 'http://localhost:8080/opt/super/create',
								method: 'POST',
								data: reqdata,
								success: function(rel) {
									layer.msg(rel.msg);
									if (rel.code === 0) {
										location.reload();
									}
								}
							})
							//
							layer.close(index); //如果设定了yes回调，需进行手工关闭
						}
					})
				})
				$('#upload-btn').click(function() {
					var fileoploadlayer = layer.open({
						title: '文件上传',
						type: 1,
						skin: 'layui-layer-rim', //加上边框
						area: ['420px', '240px'], //宽高
						content: '<div id="upload-box" class="layui-upload" style="margin-top: 20px;text-align: center;"><button type="button" class="layui-btn layui-btn-normal" id="test8">选择文件</button><br/><br/><button type="button" class="layui-btn" id="test9">开始上传</button></div>'
					});
					//选完文件后不自动上传
					upload.render({
						elem: '#test8',
						url: 'http://localhost:8080/opt/super/upload' //改成您自己的上传接口
							,
						auto: false
							//,multiple: true
							,
						bindAction: '#test9',
						done: function(res) {
							layer.close(fileoploadlayer);
							layer.msg(res.msg);
							//console.log(res);
							location.reload();
						}
					});
				})
				$('#refresh-cache-btn').click(function() {
					$.ajax({
						url: 'http://localhost:8080/main/updatecache',
						method: 'POST',
						success: function(suc) {
							//刷新页面
							if (suc) {
								location.reload();
							} else {
								layer.msg('缓存刷新失败');
							}
						}
					});
				})

				$('#change-btn-group').click(function(){
					var idx = $(this).attr('data-group-idx');
					if(idx === '1'){
						$('.btn-group-2').show();
						$('.btn-group-1').hide();
						$(this).attr('data-group-idx','2')
					}
					if(idx === '2'){
						$('.btn-group-1').show();
						$('.btn-group-2').hide();
						$(this).attr('data-group-idx','1')
					}
					//var btn_group_clazzname = 'btn-group-' + $(this).attr('data-group-idx')
					
				})

				function fileNode(node) {



					var _isfile = !node.folder;
					var _name = node.name;
					var _path = node.path;
					var _time = node.updatetime.substring(0, 10) + ' ' + node.updatetime.substring(11, 16);
					var _type = '';
					var _size = '';
					var _isfavorite = node.favorite;

					if (_isfile) {
						_type = "TXT";
						var _idx = _name.lastIndexOf(".");
						if (_idx === -1) {
							_type = "类型未知";
						} else {
							_type = _name.substring(_idx + 1, _name.length).toUpperCase();
						}

						_size = parseFloat(node.size).toLocaleString() + ' KB';
					} else {
						_type = "文件夹";
						_size = '';
					}




					return '\
					<blockquote class="layui-elem-quote  layui-quote-nm">\
						<div class="layui-row layui-col-space5" style="text-align: center;">\
							<div class="layui-col-md4"  style="text-align: left;">\
								<span class="file-name-span" data-path="' +
						_path + '" data-file-type="' + _type + '">' + _name +
						'</span>\
							</div>\
							<div class="layui-col-md2">\
								' + _time +
						'\
							</div>\
							<div class="layui-col-md1">\
								<span class="layui-badge layui-bg-' + (_isfile ?
							'orange' : 'gray') + '">' + _type + '</span>\
							</div>\
							<div class="layui-col-md2">\
								' +
						_size +
						'\
							</div>\
							<div class="layui-col-md3">\
								<div class="layui-btn-group btn-group-1" data-path="' +_path +'">\
									<button type="button" class="add-favorite-btn play-btn layui-btn layui-bg-red layui-btn-xs" data-is-favorite="' +
						_isfavorite + '"><i class="layui-icon">' + (_isfavorite ? '&#xe658;' : '&#xe600;') +
						'</i></button>\
									<button type="button" class="file-move-btn layui-btn layui-btn-xs">移动</button>\
									<button type="button" class="file-copy-btn layui-btn layui-btn-xs">复制</button>\
									<button type="button" class="file-rename-btn layui-btn layui-btn-xs">重命名</button>\
								</div>\
								<div class="layui-btn-group btn-group-2" data-path="' +_path +'">\
									<button type="button" class="file-delete-btn layui-btn layui-btn-xs"><i class="layui-icon">&#xe640;</i></button>\
									<button type="button" class="file-download-btn delete-btn layui-btn layui-btn-xs"><i class="layui-icon">&#xe601;</i></button>\
									<button type="button" class="file-info-btn layui-btn layui-btn-primary layui-btn-xs"><i class="layui-icon">&#xe702;</i></button>\
									<button type="button" class="file-zip-btn layui-btn layui-btn-xs"><i class="layui-icon">&#xe857;</i></button>\
								</div>\
							</div>\
						</div>\
					</blockquote>\
					';
				}



				$.post('http://localhost:8080/main/list', function(rel) {
					console.log(rel);
					if (rel.code === 0) {
						// $('#file-list-box').append(fileNode());
						rel.data.forEach(function(val) {
							if (!val.folder) {
								return;
							}
							// console.log(val);
							$('#file-list-box').append(fileNode(val));
							//文件
						})
						rel.data.forEach(function(val) {
							if (val.folder) {
								return;
							}
							// console.log(val);
							$('#file-list-box').append(fileNode(val));
							//文件夹
						})
						
						//隐藏某部分个操作项
						$('#change-btn-group').click();

						$('.file-name-span').click(function() {
							var _name = $(this).html();
							var _type = $(this).attr('data-file-type');
							var _path = $(this).attr('data-path');
							if (_type === '文件夹') {
								//layer.msg("进入文件夹")
								$.ajax({
									url: 'http://localhost:8080/main/enterfolder',
									method: 'POST',
									data: {
										folder: _path
									},
									success: function(rel) {
										//刷新页面
										if (rel.code === 0) {
											location.reload();
										} else if (rel.code === -1) {
											layer.msg(rel.msg);
											//文件夹被加密
											layer.open({
												title: '输入密码',
												content: '<input type="text" name="password" lay-verify="title" autocomplete="off" placeholder="文件夹密码" class="layui-input">',
												yes: function(index, layero) {
													//do something
													var password = $(layero.find('.layui-input')).val();
													var reqdata = {
														password: password,
														folder: _path
													};
													$.ajax({
														url: 'http://localhost:8080/main/enterfolder',
														method: 'POST',
														data: reqdata,
														success: function(rel) {
															if (rel.code === 0) {
																location.reload();
															} else {
																layer.msg(rel.msg)
															}
														}
													});
												}
											})
										}
									}
								});

							} else if (_type === '类型未知') {
								layer.msg("无法查看此文件")
							} else if (_type === 'ZIP') {
								//layer.msg("解压文件"+_path)
								//询问框
								layer.confirm('是否解压文件' + _name + '？', {
									btn: ['解压', '解压到', '取消'] //按钮
								}, function() {
									//layer.msg('解压');
									//解压文件
									$.post('http://localhost:8080/opt/super/unzip', {path:_path}, function() {
										layer.msg(rel.msg);
										if (rel.code === 0) {
											location.reload();
										}
									})
								}, function() {
									layer.open({
										title: '解压到',
										content: '<input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="目标路径" class="layui-input">',
										yes: function(index, layero) {
											//do something
											var folder = $(layero.find('.layui-input')).val();
											var reqdata = {
												path: _path,
												folder: folder
											};
											$.post('http://localhost:8080/opt/super/unzip', reqdata, function() {
												layer.msg(rel.msg);
												if (rel.code === 0) {
													location.reload();
												}
											})
											layer.close(index); //如果设定了yes回调，需进行手工关闭
										}
									})
								});
							} else if( ['C','YML','CPP','JAVA','BAT','REG','JS','CSS','HTML','XML','PROPERTIES'].includes(_type) ) {
								//layer.msg("查看代码类型文件")
								$.post('http://localhost:8080/file/view/text/code',{path:_path},function(rel){
									console.log(rel);
									var e_code =  $("<div>").text(rel.data).html();
									layer.open({
									  type: 1,
									  title: false,
									  closeBtn: 0,
									  area: ['1000px','560px'],
									  shadeClose: true,
									  content: '<pre lay-title="'+rel.ext+'" lay-height="500px" lay-skin="" lay-encode="true" class="layui-code">'+e_code+'</pre>'
									});
									layui.code(); //引用code方法
									
								})
							} else if (['DOCX','DOC'].includes(_type)){
								$.post("http://localhost:8080/file/view/office/word",{path:_path},function(rel){
									if(rel.code === 1){
										layer.open({
										  type: 1,
										  title: _name,
										  shadeClose: true,
										  shade: false,
										  maxmin: true, //开启最大化最小化按钮
										  area: ['1100px', '600px'],
										  content: rel.data
										});
									}else{
										layer.msg(rel.msg)
									}
								})
							} else if (['XLSX','XLS'].includes(_type)){
								$.post("http://localhost:8080/file/view/office/excel",{path:_path},function(rel){
									if(rel.code === 1){
										layer.open({
										  type: 1,
										  title: _name,
										  shadeClose: true,
										  shade: false,
										  maxmin: true, //开启最大化最小化按钮
										  area: ['1100px', '600px'],
										  content: rel.data
										});
									}else{
										layer.msg(rel.msg)
									}
								})
							} else if (['PPT','PPTX'].includes(_type)){
								$.post("http://localhost:8080/file/view/office/ppt",{path:_path},function(rel){
									if(rel.code === 1){
										layer.open({
										  type: 1,
										  title: _name,
										  shadeClose: true,
										  shade: false,
										  maxmin: true, //开启最大化最小化按钮
										  area: ['1100px', '600px'],
										  content: rel.data
										});
									}else{
										layer.msg(rel.msg)
									}
								})
							} else {
								layer.msg("查看" + _type + "类型文件")
							}
						})
						$('.file-move-btn').click(function() {
							var _path = $(this).parent().attr('data-path');
							console.log("移动:", _path);
							layer.open({
								title: '移动到',
								content: '<input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="目标路径" class="layui-input">',
								yes: function(index, layero) {
									//do something
									var folder = $(layero.find('.layui-input')).val();
									var reqdata = {
										filepath: _path,
										folder: folder
									};
									$.ajax({
										url: 'http://localhost:8080/opt/moveto',
										method: 'POST',
										data: reqdata,
										success: function(rel) {
											layer.msg(rel.msg);
											if (rel.code === 0) {
												location.reload();
											}
										}
									})
									//发送复制事件
									layer.close(index); //如果设定了yes回调，需进行手工关闭
								}
							})
						})
						$('.file-copy-btn').click(function() {
							var _path = $(this).parent().attr('data-path');
							console.log("复制:", _path);
							layer.open({
								title: '复制到',
								content: '<input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="目标路径" class="layui-input">',
								yes: function(index, layero) {
									//do something
									var folder = $(layero.find('.layui-input')).val();
									var reqdata = {
										filepath: _path,
										folder: folder
									};
									$.ajax({
										url: 'http://localhost:8080/opt/copyto',
										method: 'POST',
										data: reqdata,
										success: function(rel) {
											layer.msg(rel.msg);
											if (rel.code === 0) {
												location.reload();
											}
										}
									})
									//发送复制事件
									layer.close(index); //如果设定了yes回调，需进行手工关闭
								}
							})
						})
						$('.file-rename-btn').click(function() {
							var _path = $(this).parent().attr('data-path');
							console.log("重命名:", _path);
							layer.open({
								title: '重命名',
								content: '<input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入新的名字" class="layui-input">',
								yes: function(index, layero) {
									//do something
									var newname = $(layero.find('.layui-input')).val();
									//发送重命名事件
									var reqdata = {
										filepath: _path,
										newname: newname
									};
									$.ajax({
										url: 'http://localhost:8080/opt/rename',
										method: 'POST',
										data: reqdata,
										success: function(rel) {
											layer.msg(rel.msg);
											if (rel.code === 0) {
												location.reload();
											}
										}
									})
									layer.close(index); //如果设定了yes回调，需进行手工关闭
								}
							})
						})
						$('.file-download-btn').click(function() {
							var _path = $(this).parent().attr('data-path');
							console.log("下载:", _path);
							const link = document.createElement('a');
							link.href = 'http://localhost:8080/opt/super/download?filepath=' + encodeURIComponent(_path);
							link.click();
						})
						$('.file-delete-btn').click(function() {
							var _path = $(this).parent().attr('data-path');
							console.log("删除:", _path);
							$.ajax({
								url: 'http://localhost:8080/opt/delete',
								method: 'POST',
								data: {
									filepath: _path
								},
								success: function(rel) {
									layer.msg(rel.msg);
									if (rel.code === 0) {
										location.reload();
									}
								}
							})
						})
						$('.file-info-btn').click(function() {
							var _path = $(this).parent().attr('data-path');
							layer.msg(_path);
						})
						$('.file-zip-btn').click(function(){
							var _path = $(this).parent().attr('data-path');
							layer.msg(_path+'123131');
							//询问框
							layer.confirm('是否压缩目录？', {
								btn: ['压缩', '压缩到', '取消'] //按钮
							}, function() {
								//layer.msg('压缩');
								//解压文件
								$.post('http://localhost:8080/opt/super/zip', {folder:_path}, function(rel) {
									layer.msg(rel.msg);
									if (rel.code === 0) {
										location.reload();
									}
								})
							}, function() {
								layer.open({
									title: '压缩为',
									content: '<input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="压缩后文件路径" class="layui-input">',
									yes: function(index, layero) {
										//do something
										var _dst = $(layero.find('.layui-input')).val();
										var reqdata = {
											folder: _path,
											dst: _dst
										};
										$.post('http://localhost:8080/opt/super/zip', reqdata, function(rel) {
											layer.msg(rel.msg);
											if (rel.code === 0) {
												location.reload();
											}
										})
										layer.close(index); //如果设定了yes回调，需进行手工关闭
									}
								})
							});
						})

						$.post('http://localhost:8080/sys/config/get', {
							key: 'favorite'
						}, function(rel) {
							// console.log(rel);
							if (rel) { //如果收藏功能开启
								$('.add-favorite-btn').click(function() {
									var _favorite = $(this).attr('data-is-favorite');
									var _path = $(this).parent().attr('data-path');
									if (_favorite === 'false') {
										//没有收藏
										// todo 收藏
										//console.log('添加收藏',_path);
										$.ajax({
											url: 'http://localhost:8080/favorite/add',
											method: 'POST',
											data: {
												path: _path
											},
											success: function(rel) {
												layer.msg(rel.msg);
											}
										})
										$(this).find('i').html('&#xe658;');
										$(this).attr('data-is-favorite', true);
									} else {
										//取消收藏
										//console.log('取消收藏');
										$.ajax({
											url: 'http://localhost:8080/favorite/remove',
											method: 'POST',
											data: {
												path: _path
											},
											success: function(rel) {
												layer.msg(rel.msg);
											}
										})
										$(this).find('i').html('&#xe600;');
										$(this).attr('data-is-favorite', false);
									}
									console.log();
								})
							} else {
								$('.add-favorite-btn').remove();
							}

						})



					} else {
						layer.msg(rel.msg);
					}
				})




			})
		</script>
	</body>
</html>
