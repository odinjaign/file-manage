<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="layui/css/layui.css" />
	</head>
	<body>
		<ul class="layui-nav layui-bg-blue">
			<li class="layui-nav-item">
				<a href="index.html"><i class="layui-icon layui-icon-home"></i></a>
			</li>
			<li class="layui-nav-item">
				<a href="musics.html">音乐</a>
			</li>
			<li class="layui-nav-item layui-this">
				<a id="update-cache">视频<span id="movie-count" class="layui-badge">0</span></a>
			</li>
			<li class="layui-nav-item">
				<a href="documents.html">文档</a>
			</li>
			<li class="layui-nav-item">
				<a href="images.html">图片</a>
			</li>
		</ul>
		<div id="movie-list-box" class="layui-container" style="margin-top: 20px">
			<blockquote class="layui-elem-quote">
				<div class="layui-row layui-col-space5" style="text-align: center;color: #009688;">
					<div class="layui-col-md5">
						名称
<!--						<span id="update-cache" class="layui-badge layui-bg-green"><i class="layui-icon">&#xe669;</i></span>-->
					</div>
					<div class="layui-col-md2">
						日期
					</div>
					<div class="layui-col-md1">
						类型
					</div>
					<div class="layui-col-md1">
						大小
					</div>
					<div class="layui-col-md1">
						时长
					</div>
					<div class="layui-col-md2">
						操作
					</div>
				</div>
			</blockquote>
			<!-- <blockquote class="layui-elem-quote layui-quote-nm">
				<div class="layui-row layui-col-space5" style="text-align: center;">
					<div class="layui-col-md5" style="text-align: left;">
						[SUBPIG][Papa ga mo ichido koi o shita ep01].mp5
					</div>
					<div class="layui-col-md2">
						2020/2/15 20:36
					</div>
					<div class="layui-col-md1">
						<span class="layui-badge layui-bg-orange">mp4</span>
					</div>
					<div class="layui-col-md1">
						<span class="layui-badge layui-bg-blue">747,743KB</span>
					</div>
					<div class="layui-col-md1">
						00:43:47
					</div>
					<div class="layui-col-md2">
						<button type="button" class="play-btn layui-btn layui-btn-primary layui-btn-xs">播放</button>
						<button type="button" class="delete-btn layui-btn layui-btn-danger layui-btn-xs">删除</button>
					</div>
				</div>
			</blockquote>
 -->
		</div>

		<script src="layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			layui.use(['element', 'layer'], function() {
				var element = layui.element;
				var $ = layui.$;

				//用户未登录的跳转
				$.post("http://localhost:8080/user/config/islogin", function(rel) {
					if (rel.code === -1) {
						layer.msg(rel.msg, function() {
							window.location = "login.html";
						})
					} else if (rel.code === 1) {
						layer.msg(rel.msg, function() {
							window.location = "sysconfig.html";
						})
					}
				})

				$.post("http://127.0.0.1:8080/sys/config/get", {
					key: "typeview"
				}, function(status) {
					if (!status) {
						layer.msg("分类浏览未启用", function() {
							window.location = "index.html";
						})
					}
				})

				function movieNodeHtml(node) {




					return '\
					<blockquote class="layui-elem-quote layui-quote-nm">\
						<div class="layui-row layui-col-space5" style="text-align: center;">\
							<div class="layui-col-md5" style="text-align: left;">\
								' +
						node.name + '\
							</div>\
							<div class="layui-col-md2">\
								' + node.time +
						'\
							</div>\
							<div class="layui-col-md1">\
								<span class="layui-badge layui-bg-orange">' +
						node.type +
						'</span>\
							</div>\
							<div class="layui-col-md1">\
								<span class="layui-badge layui-bg-blue">' +
						parseFloat(node.size).toLocaleString() +
						'KB</span>\
							</div>\
							<div class="layui-col-md1">\
								' + node.length +
						'\
							</div>\
							<div class="layui-col-md2" data-path="' + node.path +
						'">\
								<button type="button" class="play-btn layui-btn layui-btn-primary layui-btn-xs">播放</button>\
								<button type="button" class="delete-btn layui-btn layui-btn-danger layui-btn-xs">删除</button>\
							</div>\
						</div>\
					</blockquote>\
					';
				};
				$.ajax({
					url: 'http://localhost:8080/movie/list',
					type: 'POST',
					success: function(rel) {
						console.log(rel.msg);
						if (rel.code === 0) {
							rel.data.forEach(function(val, inx) {
								$("#movie-list-box").append(movieNodeHtml(val))
							});
							$("#movie-count").html(rel.count);
							$(".play-btn").click(function() {
								var path = $(this).parent().attr("data-path");
								var realpath = encodeURIComponent(path);
								layer.open({
									type: 1,
									title: false,
									shade: 0.8,
									closeBtn: 0,
									shadeClose: true,
									area: ['80%'],
									content: '<video controls="" width="100%" height="100%" preload="" src="http://localhost:8080/movie/file?path=' +
										realpath + '"></video>'
								});
							});
							//删除视频文件
							$(".delete-btn").click(function() {

								var path = $(this).parent().attr("data-path");
								$.ajax({
									url: 'http://localhost:8080/opt/delete',
									method: 'POST',
									data: {
										filepath: path
									},
									success: function(rel) {
										if (rel.code === 0) {
											//location.reload();
											$("#update-cache").click();
										}else {
											layer.msg(rel.msg);
										}
									}
								})
							})
						}
					}
				});
				//刷新缓存
				$('#update-cache').click(function () {
					$.post('http://localhost:8080/class/manage/del/cache',function (rel) {
						if (rel.code === 0) {
							location.reload()
						}else {
							layer.apply(rel.msg)
						}
					})
				})
			});
		</script>
	</body>
</html>
